name: "Deploy Release Artifact"
on:
  workflow_dispatch:
  push:
    branches:
      - main
    tags:
      - "v[0-9]+.[0-9]+.[0-9]+-?*"

defaults:
  run:
    shell: bash

env:
  LC_ALL: C.UTF-8
  GRADLE_CACHE_USERNAME: ${{ secrets.GRADLE_CACHE_USERNAME }}
  GRADLE_CACHE_PASSWORD: ${{ secrets.GRADLE_CACHE_PASSWORD }}

jobs:
  plugin-portal-release:
    name: Release Gradle Plugin Portal
    runs-on: network-node-linux-medium
    steps:
      - name: Checkout Code
        uses: actions/checkout@b4ffde65f46336ab88eb53be808477a3936bae11 # v4.1.1
        with:
          fetch-depth: 0

      - name: Setup Java
        uses: actions/setup-java@387ac29b308b003ca37ba93a6cab5eb57c8f5f93 # v4.0.0
        with:
          distribution: temurin
          java-version: 17.0.12

      - name: Setup Gradle
        uses: gradle/actions/setup-gradle@d156388eb19639ec20ade50009f3d199ce1e2808 # v4.1.0

#      - name: Install GnuPG Tools
#        run: |
#          if ! command -v gpg2 >/dev/null 2>&1; then
#            echo "::group::Updating APT Repository Indices"
#              sudo apt update
#            echo "::endgroup::"
#            echo "::group::Installing GnuPG Tools"
#              sudo apt install -y gnupg2
#            echo "::endgroup::"
#          fi
#
#      - name: Import GPG key
#        id: gpg_key
#        uses: crazy-max/ghaction-import-gpg@01dd5d3ca463c7f10f7f4f7b4f177225ac661ee4 # v6.1.0
#        with:
#          gpg_private_key: ${{ secrets.GPG_KEY_CONTENTS }}
#          passphrase: ${{ secrets.GPG_KEY_PASSPHRASE }}
#          git_config_global: true
#          git_user_signingkey: true
#          git_commit_gpgsign: true
#          git_tag_gpgsign: true

      - name: Gradle Plugin Portal Release
        env:
          GRADLE_PUBLISH_KEY: ${{ secrets.GRADLE_PUBLISH_KEY }}
          GRADLE_PUBLISH_SECRET: ${{ secrets.GRADLE_PUBLISH_SECRET }}
#        run: ./gradlew publishPlugins -PpublishSigningEnabled=true --no-configuration-cache --scan
        run: ./gradlew publish --no-configuration-cache --scan
